#!/usr/bin/env ruby

# Copyright 2008-2011 Red Hat, Inc, and individual contributors.
# 
# This is free software; you can redistribute it and/or modify it
# under the terms of the GNU Lesser General Public License as
# published by the Free Software Foundation; either version 2.1 of
# the License, or (at your option) any later version.
# 
# This software is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
# Lesser General Public License for more details.
# 
# You should have received a copy of the GNU Lesser General Public
# License along with this software; if not, write to the Free
# Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA
# 02110-1301 USA, or see the FSF site: http://www.fsf.org.

require 'thor'
require 'torquebox-rake-support'
require 'torquebox/server'

class TorqueBoxCommand < Thor

  map "run" => "start"
  desc "run", "Run TorqueBox"
  def start
    setup_environment
    TorqueBox::DeployUtils.run_server
  end

  desc "deploy ROOT", "Deploy an application to TorqueBox"
  long_desc <<-EOS
    Deploy an application to TorqueBox. The ROOT argument should point to either
    a directory containing the application you want to deploy, a -knob.yml file,
    a .knob archive, or any Java deployable artifact (.war, .ear, etc).
  EOS
  method_option :context_path, :type => :string, :desc => "Context Path (ex: /, /my_app)"
  method_option :env, :type => :string, :desc => "Application Environment (ex: development, test, production)"
  def deploy(root)
    setup_environment
    root = File.expand_path(root)
    opts = {:root => root}.merge(options)
    descriptor = TorqueBox::DeployUtils.basic_deployment_descriptor(opts)
    deployment_name = TorqueBox::DeployUtils.deployment_name(root)
    deployed_name, deploy_dir = TorqueBox::DeployUtils.deploy_yaml(descriptor, deployment_name)
    puts "Deployed: #{deployed_name}"
    puts "    into: #{deploy_dir}"
  end

  desc "undeploy ROOT", "Undeploy an application from TorqueBox"
  def undeploy(root)
    setup_environment
    root = File.expand_path(root)
    deployment_name = TorqueBox::DeployUtils.deployment_name(root)
    deploy_name, deploy_dir = TorqueBox::DeployUtils.undeploy(deployment_name)

    if deploy_name
      puts "Undeployed: #{deploy_name}"
      puts "      from: #{deploy_dir}"
    else
      puts "Nothing to undeploy"
    end
  end

  desc "cli", "Run the JBoss AS7 CLI"
  def cli
    setup_environment
    windows_path = File.join(TorqueBox::Server.jboss_home, "bin\\jboss-admin")
    unix_path = "/bin/sh #{File.join(TorqueBox::Server.jboss_home, 'bin/jboss-admin.sh')}"
    command = Config::CONFIG['host_os'] =~ /mswin/ ? windows_path : unix_path
    exec command
  end

  no_tasks {
    def setup_environment
      ENV['TORQUEBOX_HOME'] = TorqueBox::Server.torquebox_home
      ENV['JBOSS_HOME'] = TorqueBox::Server.jboss_home
      ENV['JBOSS_OPTS'] = "-Djruby.home=#{TorqueBox::Server.jruby_home}"
    end
  }

end

TorqueBoxCommand.start
